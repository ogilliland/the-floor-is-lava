<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>The Floor is Lava!</title>
    <style>
    	* { padding: 0; margin: 0; }
    	html { background-color: rgba(0, 0, 0, 1); }
    	#gameCanvas { background: rgba(250, 250, 250, 1); display: block; margin: 0 auto; position: absolute; width: 100%; height: 100%; }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
	var canvas = document.getElementById("gameCanvas");
	var ctx = canvas.getContext("2d");

	// world building
	var gravity = 0.5;
	var friction = 0.2;
	var meltRate = 0.2;
	var score = 0;

	// the floor is lava
	var lavaMainColor = "#FF8000";
	var lavaSurfaceColor = "#FFC000";
	var lavaBottomHeight = 125;
	var lavaMainHeight = 200;
	var lavaSurfaceHeight = 3;

	function updateCanvas() {
		canvas.width = $(window).width();
		canvas.height = $(window).height();
	}

	// used to define player object
	function Player(radius, speed, x, y, dx, dy) {
		this.radius = radius;
		this.speed = speed;
		this.x = x;
		this.y = y;
		this.dx = dx;
		this.dy = dy;
		this.isAlive = true;
		this.onGround = false;
	}

	// used to define rock objects
	function Rock(x, y, width, height) {
		this.x = x;
		this.y = y;
		this.a = 0; // angle relative to horizontal
		this.da = 0; // angular velocity
		this.width = width;
		this.height = height;
		this.targetHeight = height;
		this.targetY = y;
	}

	var rocks = new Array();
	function addRock(x, y, width, height) {
		rocks.push(new Rock(x, y, width, height));
	}

	function meltRock(id, rate) {
		if(rocks[id].targetHeight - rate > 0) {
			rocks[id].targetHeight += (-1) * rate;
			rocks[id].targetY += rate/2;
		} else {
			rocks[id].height = 0;
			rocks[id].targetY = 200;
		}
	}

	function drawScore() {
		ctx.font = "24px Arial";
		ctx.fillStyle = "#646464";
		ctx.fillText("Score: " + score, 50, 70);
	}

	function drawPlayer() {
		ctx.beginPath();
		ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
		ctx.fillStyle = "#000000";
		ctx.fill();
		ctx.closePath();
	}

	function drawBackground() {
		ctx.beginPath();
		ctx.rect(
			0,
			canvas.height - lavaMainHeight,
			canvas.width,
			lavaMainHeight
		);
		ctx.strokeStyle = lavaMainColor;
		ctx.stroke();
		ctx.fillStyle = lavaMainColor;
		ctx.fill();
		ctx.closePath();
		ctx.beginPath();
		ctx.rect(
			0,
			canvas.height - lavaMainHeight - lavaSurfaceHeight,
			canvas.width,
			lavaSurfaceHeight
		);
		ctx.strokeStyle = lavaSurfaceColor;
		ctx.stroke();
		ctx.fillStyle = lavaSurfaceColor;
		ctx.fill();
		ctx.closePath();
	}

	function drawForeground() {
		ctx.beginPath();
		ctx.rect(
			0,
			canvas.height - lavaBottomHeight,
			canvas.width,
			lavaMainHeight
		);
		ctx.fillStyle = lavaMainColor;
		ctx.fill();
		ctx.closePath();
	}

	function calculateVertX(ox, vx, vy, angle) {
		return ox + vx * Math.cos(angle) - vy * Math.sin(angle);
	}

	function calculateVertY(oy, vx, vy, angle) {
		return oy + vx * Math.sin(angle) + vy * Math.cos(angle);
	}

	function drawRocks() {
		for(var i = 0; i < rocks.length; i++) {
			// front face
			ctx.beginPath();
			ctx.moveTo(
				calculateVertX(
					rocks[i].x,
					0.5 * rocks[i].width,
					0.5 * rocks[i].height,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					0.5 * rocks[i].width,
					0.5 * rocks[i].height,
					rocks[i].a
				)
			);
			ctx.lineTo(
				calculateVertX(
					rocks[i].x,
					0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				)
			);
			ctx.lineTo(
				calculateVertX(
					rocks[i].x,
					-0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					-0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				)
			);
			ctx.lineTo(
				calculateVertX(
					rocks[i].x,
					-0.5 * rocks[i].width,
					0.5 * rocks[i].height,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					-0.5 * rocks[i].width,
					0.5 * rocks[i].height,
					rocks[i].a
				)
			);
			ctx.strokeStyle = "#646464";
			ctx.stroke();
			ctx.fillStyle = "#646464";
			ctx.fill();
			ctx.closePath();
			// top face
			ctx.beginPath();
			ctx.moveTo(
				calculateVertX(
					rocks[i].x,
					0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				)
			);
			ctx.lineTo(
				calculateVertX(
					rocks[i].x,
					0.5 * rocks[i].width - 20,
					-0.5 * rocks[i].height - 20,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					0.5 * rocks[i].width - 20,
					-0.5 * rocks[i].height - 20,
					rocks[i].a
				)
			);
			ctx.lineTo(
				calculateVertX(
					rocks[i].x,
					-0.5 * rocks[i].width + 20,
					-0.5 * rocks[i].height - 20,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					-0.5 * rocks[i].width + 20,
					-0.5 * rocks[i].height - 20,
					rocks[i].a
				)
			);
			ctx.lineTo(
				calculateVertX(
					rocks[i].x,
					-0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				),
				calculateVertY(
					rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
					-0.5 * rocks[i].width,
					-0.5 * rocks[i].height,
					rocks[i].a
				)
			);
			ctx.strokeStyle = "#7D7D7D";
			ctx.stroke();
			ctx.fillStyle = "#7D7D7D";
			ctx.fill();
			ctx.closePath();
		}
	}

	function simulatePhysics() {
		if(player.isAlive) {
			if(jump > 0 && player.onGround) {
				player.dy = -20;
				player.onGround = false;
			}
			if(left - right > 0) {
				if(player.dx < player.speed) {
					player.dx += player.speed/10;
				}
			} else if (left - right < 0) {
				if(player.dx > (-1) * player.speed) {
					player.dx += (-1) * player.speed/10;
				}
			} else {
				player.dx += (-1) * player.dx * friction;
			}
			player.x += player.dx;
			player.y += player.dy;
			player.dy += gravity;
			for(var i = 0; i < rocks.length; i++) {
				// rotate rocks
				rocks[i].a += rocks[i].da;
				rocks[i].da = (-0.0005) * rocks[i].a + 0.975 * rocks[i].da;
				// melt rocks
				rocks[i].height += (rocks[i].targetHeight - rocks[i].height)/10;
				rocks[i].y += (rocks[i].targetY - rocks[i].y)/10;
				// make player collide with rock surface
				var leftPoint = calculateVertX(
							rocks[i].x,
							-0.5 * rocks[i].width,
							-0.5 * rocks[i].height,
							rocks[i].a
				)
				var rightPoint = calculateVertX(
							rocks[i].x,
							0.5 * rocks[i].width,
							-0.5 * rocks[i].height,
							rocks[i].a
				)
				if(player.x > leftPoint && player.x < rightPoint) {
					var leftHeight = calculateVertY(
								rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
								-0.5 * rocks[i].width,
								-0.5 * rocks[i].height,
								rocks[i].a
					)
					var rightHeight = calculateVertY(
								rocks[i].y + (canvas.height - lavaMainHeight - lavaSurfaceHeight),
								0.5 * rocks[i].width,
								-0.5 * rocks[i].height,
								rocks[i].a
					)
					var slope = (rightHeight - leftHeight)/(rightPoint - leftPoint);
					var rockSurface = leftHeight + slope * (player.x - leftPoint);
					if(player.y + 20 > rockSurface && player.y < rockSurface + 20) {
						if(player.onGround) {
							// player is resting on rock
							rocks[i].da += (player.x - rocks[i].x)/1000000;
							meltRock(i, meltRate);
						} else {
							// player just landed on rock
							if(i > score) {
								score = i;
							}
							rocks[i].da += 2 * player.dy * (player.x - rocks[i].x)/1000000;
							meltRock(i, 50 * meltRate);
							player.onGround = true;
						}
						player.y = rockSurface - 20;
						player.dy = 0;
					}
				}
			}
			if(player.y > canvas.height - lavaBottomHeight) {
				player.isAlive = false;
			}
		}
	}

	var left = 0;
	var right = 0;
	var jump = 0;
	window.onkeyup = function(e) {
		var unicode = e.keyCode ? e.keyCode : e.charCode;
    	if(unicode == 37 || unicode == 65) {
			right = 0;
		}
		if(unicode == 39 || unicode == 68) {
			left = 0;
		}
		if(unicode == 87 || unicode == 38 || unicode == 32) {
			jump = 0;
		}
    }
	window.onkeydown = function(e) {
		var unicode = e.keyCode ? e.keyCode : e.charCode;
    	if(unicode == 37 || unicode == 65) {
			right = 1;
		}
		if(unicode == 39 || unicode == 68) {
			left = 1;
		}
		if(unicode == 87 || unicode == 38 || unicode == 32) {
			jump = 1;
		}
    }

    updateCanvas();
    var player = new Player(10, 10, canvas.width/2, canvas.height/2, 0, 0);
    addRock(0.5 * canvas.width, 40, canvas.width - 200, 125);
    
	function draw() {
		updateCanvas();
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		// update positions and values
		simulatePhysics();
		// render objects
		drawBackground(); // lava
		drawRocks();
		drawPlayer();
		drawForeground(); // lava
	    	drawScore();
	    	requestAnimationFrame(draw);
	}
	draw();
</script>

</body>
</html>
